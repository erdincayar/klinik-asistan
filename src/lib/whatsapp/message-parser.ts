import Anthropic from "@anthropic-ai/sdk";
import { prisma } from "@/lib/prisma";

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export interface ParsedAppointment {
  type: "APPOINTMENT";
  patientName: string;
  date: string;
  time: string;
  treatmentType: string;
  notes: string;
}

export interface ParsedIncome {
  type: "INCOME";
  patientName: string;
  treatmentType: string;
  treatmentName: string;
  amount: number;
  notes: string;
}

export interface ParsedExpense {
  type: "EXPENSE";
  description: string;
  amount: number;
  category: string;
}

export interface ParsedAmbiguous {
  type: "AMBIGUOUS";
  message: string;
  originalText: string;
  options: string[];
}

export interface ParseError {
  type: "ERROR";
  message: string;
  originalText: string;
}

export type ParsedMessage =
  | ParsedAppointment
  | ParsedIncome
  | ParsedExpense
  | ParsedAmbiguous
  | ParseError;

function buildSystemPrompt(): string {
  const today = new Date();
  const todayStr = today.toISOString().split("T")[0];
  const dayNames = [
    "Pazar",
    "Pazartesi",
    "SalÄ±",
    "Ã‡arÅŸamba",
    "PerÅŸembe",
    "Cuma",
    "Cumartesi",
  ];
  const dayOfWeek = dayNames[today.getDay()];

  // Pre-calculate upcoming dates for each day name
  const upcomingDates: Record<string, string> = {};
  for (let i = 1; i <= 7; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() + i);
    const name = dayNames[d.getDay()].toLowerCase();
    if (!upcomingDates[name]) {
      upcomingDates[name] = d.toISOString().split("T")[0];
    }
  }

  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const tomorrowStr = tomorrow.toISOString().split("T")[0];

  return `Sen bir klinik yÃ¶netim sistemi iÃ§in WhatsApp mesaj ayrÄ±ÅŸtÄ±rÄ±cÄ±sÄ±sÄ±n.
Doktorun doÄŸal dilde yazdÄ±ÄŸÄ± kÄ±sa TÃ¼rkÃ§e mesajlarÄ± yapÄ±landÄ±rÄ±lmÄ±ÅŸ JSON verisine dÃ¶nÃ¼ÅŸtÃ¼rÃ¼yorsun.

## BugÃ¼nÃ¼n Bilgileri
- BugÃ¼n: ${todayStr} (${dayOfWeek})
- YarÄ±n: ${tomorrowStr}
- YaklaÅŸan gÃ¼nler: ${Object.entries(upcomingDates).map(([day, date]) => `${day} â†’ ${date}`).join(", ")}

## 3 Mesaj Tipi

### 1. RANDEVU (APPOINTMENT)
Hasta adÄ± + zaman bilgisi (gÃ¼n/saat) iÃ§eren mesajlar.
Ã–rnekler:
- "erdinÃ§ ayar Ã§arÅŸamba 3 dolgu randevu" â†’ ErdinÃ§ Ayar, Ã§arÅŸamba 15:00, Dolgu
- "AyÅŸe YÄ±lmaz pazartesi saat 3 botoks kontrol" â†’ randevu
- "Mehmet yarÄ±n 14:30 dolgu" â†’ randevu
- "yarÄ±n 2ye mehmet diÅŸ tedavi" â†’ Mehmet, yarÄ±n 14:00, DiÅŸ tedavi
- "ali bey cuma 10 diÅŸ tedavi" â†’ randevu
- "zeynep 15:00 botoks" â†’ bugÃ¼n 15:00 randevu (gÃ¼n belirtilmemiÅŸse bugÃ¼n)

### 2. GELÄ°R (INCOME)
Hasta adÄ± + iÅŸlem/tedavi + tutar (TL/lira) iÃ§eren mesajlar. Bir kiÅŸiye yapÄ±lan iÅŸlem ve Ã¶deme.
Ã–rnekler:
- "Kerem Ä°nanÄ±r dolgu 5000tl alÄ±ndÄ±" â†’ Kerem Ä°nanÄ±r, Dolgu, 5000 TL
- "AyÅŸe botoks 3000tl" â†’ AyÅŸe, Botoks, 3000 TL
- "Fatma hanÄ±m botoks 3500 lira" â†’ gelir
- "Ahmet bey diÅŸ tedavi 2000tl Ã¶dendi" â†’ gelir
- "mehmet 7500tl dolgu" â†’ gelir

### 3. GÄ°DER (EXPENSE)
Hasta adÄ± OLMAYAN, Ã¼rÃ¼n/malzeme/kira/fatura/maaÅŸ gibi iÅŸletme gideri + tutar iÃ§eren mesajlar.
Ã–rnekler:
- "Nurederm Ã¼rÃ¼n alÄ±ndÄ± 50000tl Ã¶dendi" â†’ Nurederm Ã¼rÃ¼n alÄ±mÄ±, 50000 TL
- "Kira 25000 Ã¶dendi" â†’ Kira, 25000 TL
- "malzeme alÄ±mÄ± 15000tl" â†’ Malzeme alÄ±mÄ±, 15000 TL
- "Elektrik faturasÄ± 3500tl" â†’ gider
- "maaÅŸ 20000tl" â†’ gider

### 4. BELÄ°RSÄ°Z (AMBIGUOUS)
EÄŸer mesaj birden fazla ÅŸekilde yorumlanabiliyorsa (Ã¶rneÄŸin gelir mi gider mi belli deÄŸilse), AMBIGUOUS dÃ¶ndÃ¼r ve seÃ§enekleri sun.

## Saat KurallarÄ±
- Tek sayÄ± saat: 1-6 arasÄ± â†’ Ã¶ÄŸleden sonra kabul et (1â†’13:00, 2â†’14:00, 3â†’15:00, 4â†’16:00, 5â†’17:00, 6â†’18:00)
- Tek sayÄ± saat: 7-12 arasÄ± â†’ sabah kabul et (7â†’07:00, 8â†’08:00, 9â†’09:00, 10â†’10:00, 11â†’11:00, 12â†’12:00)
- "saat 3" â†’ 15:00, "3e" veya "3'e" â†’ 15:00, "2ye" veya "2'ye" â†’ 14:00
- "14:30" â†’ 14:30 (24 saat formatÄ± direkt al)
- Saat belirtilmemiÅŸse ve randevu ise: "09:00" varsayÄ±lan

## GÃ¼n KurallarÄ±
- "bugÃ¼n" â†’ ${todayStr}
- "yarÄ±n" â†’ ${tomorrowStr}
- "pazartesi", "salÄ±", vb. â†’ yaklaÅŸan ilk o gÃ¼n (yukarÄ±daki tarihleri kullan)
- GÃ¼n belirtilmemiÅŸse ve randevu ise: bugÃ¼nÃ¼ kullan (${todayStr})

## Tutar KurallarÄ±
- TutarlarÄ± HER ZAMAN kuruÅŸ cinsine Ã§evir: 5000 TL â†’ 500000, 3500 lira â†’ 350000
- "tl", "TL", "Tl", "lira", "â‚º" hepsini tanÄ±
- Binlik ayraÃ§ kullanÄ±labilir: "50.000tl" â†’ 5000000 kuruÅŸ

## Tedavi/Ä°ÅŸlem TÃ¼rleri
- "botoks", "botox", "btx" â†’ BOTOX
- "dolgu", "filler" â†’ DOLGU
- "diÅŸ", "diÅŸ tedavi", "diÅŸ tedavisi" â†’ DIS_TEDAVI
- DiÄŸer her ÅŸey â†’ GENEL

## Gider Kategorileri
- "malzeme", "Ã¼rÃ¼n", "sarf" â†’ MALZEME
- "kira" â†’ KIRA
- "elektrik", "su", "doÄŸalgaz", "fatura", "internet", "telefon" â†’ FATURA
- "maaÅŸ", "personel" â†’ MAAS
- DiÄŸer â†’ DIGER

## Ã–nemli Kurallar
- "hanÄ±m", "bey", "hoca" gibi hitap ekleri hasta adÄ±na DAHÄ°L ETMEMELÄ°SÄ°N
- Hasta adÄ±nÄ± dÃ¼zgÃ¼n bÃ¼yÃ¼k harfle yaz (Title Case): "mehmet" â†’ "Mehmet"
- SADECE JSON dÃ¶ndÃ¼r, baÅŸka hiÃ§bir metin yazma
- JSON markdown code block kullanma, dÃ¼z JSON dÃ¶ndÃ¼r`;
}

export async function parseWhatsAppMessage(
  message: string
): Promise<ParsedMessage> {
  const apiKey = process.env.ANTHROPIC_API_KEY;
  if (!apiKey || apiKey === "your-anthropic-api-key" || apiKey.length < 10) {
    return {
      type: "ERROR",
      message:
        "ANTHROPIC_API_KEY ayarlanmamÄ±ÅŸ. .env dosyasÄ±na gerÃ§ek API anahtarÄ±nÄ± ekleyin.",
      originalText: message,
    };
  }

  const systemPrompt = buildSystemPrompt();

  const userPrompt = `Mesaj: "${message}"

AÅŸaÄŸÄ±daki JSON formatlarÄ±ndan uygun olanÄ±nÄ± dÃ¶ndÃ¼r:

RANDEVU:
{"type":"APPOINTMENT","patientName":"Ad Soyad","date":"YYYY-MM-DD","time":"HH:MM","treatmentType":"BOTOX|DOLGU|DIS_TEDAVI|GENEL","notes":"varsa ek not"}

GELÄ°R:
{"type":"INCOME","patientName":"Ad Soyad","treatmentType":"BOTOX|DOLGU|DIS_TEDAVI|GENEL","treatmentName":"iÅŸlem aÃ§Ä±klamasÄ±","amount":kuruÅŸ_cinsinden_sayÄ±,"notes":"varsa ek not"}

GÄ°DER:
{"type":"EXPENSE","description":"gider aÃ§Ä±klamasÄ±","amount":kuruÅŸ_cinsinden_sayÄ±,"category":"MALZEME|KIRA|FATURA|MAAS|DIGER"}

BELÄ°RSÄ°Z:
{"type":"AMBIGUOUS","message":"kullanÄ±cÄ±ya sorulacak soru","originalText":"orijinal mesaj","options":["seÃ§enek1","seÃ§enek2"]}

HATA:
{"type":"ERROR","message":"neden anlaÅŸÄ±lamadÄ±","originalText":"orijinal mesaj"}`;

  try {
    const response = await anthropic.messages.create({
      model: "claude-sonnet-4-20250514",
      max_tokens: 500,
      system: systemPrompt,
      messages: [{ role: "user", content: userPrompt }],
    });

    const textBlock = response.content.find(
      (block): block is Anthropic.TextBlock => block.type === "text"
    );

    if (!textBlock) {
      return {
        type: "ERROR",
        message: "AI yanÄ±t vermedi",
        originalText: message,
      };
    }

    // Extract JSON - handle both plain JSON and markdown code blocks
    let jsonStr = textBlock.text.trim();
    const jsonMatch = jsonStr.match(/```(?:json)?\s*([\s\S]*?)```/);
    if (jsonMatch) {
      jsonStr = jsonMatch[1].trim();
    }

    const parsed = JSON.parse(jsonStr);
    return parsed as ParsedMessage;
  } catch (error: any) {
    console.error("[WhatsApp Parser] Error:", error?.message || error);

    if (error?.status === 401) {
      return {
        type: "ERROR",
        message: "API anahtarÄ± geÃ§ersiz. .env dosyasÄ±ndaki ANTHROPIC_API_KEY'i kontrol edin.",
        originalText: message,
      };
    }

    return {
      type: "ERROR",
      message: "Mesaj parse edilemedi. LÃ¼tfen tekrar deneyin.",
      originalText: message,
    };
  }
}

export async function findOrCreatePatient(
  name: string,
  clinicId: string,
  phone?: string
): Promise<{ patient: any; isNew: boolean }> {
  const cleanName = name
    .trim()
    .replace(/\s+(hanÄ±m|bey|hoca|hocam)$/i, "")
    .trim();
  const nameParts = cleanName.split(/\s+/);
  const firstName = nameParts[0];

  // Try full name match first
  let patient = await prisma.patient.findFirst({
    where: {
      clinicId,
      name: { contains: cleanName },
    },
  });

  // Try first name match
  if (!patient && firstName.length >= 2) {
    patient = await prisma.patient.findFirst({
      where: {
        clinicId,
        name: { contains: firstName },
      },
    });
  }

  if (patient) {
    return { patient, isNew: false };
  }

  // Create new patient
  const newPatient = await prisma.patient.create({
    data: {
      name: cleanName,
      phone: phone || null,
      clinicId,
    },
  });

  return { patient: newPatient, isNew: true };
}

export interface ProcessResult {
  success: boolean;
  parsed: ParsedMessage;
  confirmationMessage: string;
  patientIsNew?: boolean;
  recordId?: string;
}

export async function processWhatsAppMessage(
  message: string,
  clinicId: string
): Promise<ProcessResult> {
  const parsed = await parseWhatsAppMessage(message);

  if (parsed.type === "ERROR") {
    return {
      success: false,
      parsed,
      confirmationMessage: `âŒ ${parsed.message}`,
    };
  }

  if (parsed.type === "AMBIGUOUS") {
    const options = parsed.options.map((o, i) => `${i + 1}. ${o}`).join("\n");
    return {
      success: false,
      parsed,
      confirmationMessage: `ğŸ¤” ${parsed.message}\n\n${options}\n\nLÃ¼tfen netleÅŸtirerek tekrar yazÄ±n.`,
    };
  }

  try {
    if (parsed.type === "APPOINTMENT") {
      const { patient, isNew } = await findOrCreatePatient(
        parsed.patientName,
        clinicId
      );

      // Calculate endTime (30 min after startTime)
      const [h, m] = parsed.time.split(":").map(Number);
      const endMinutes = h * 60 + m + 30;
      const endTime = `${Math.floor(endMinutes / 60).toString().padStart(2, "0")}:${(endMinutes % 60).toString().padStart(2, "0")}`;

      const appointment = await prisma.appointment.create({
        data: {
          patientId: patient.id,
          clinicId,
          date: new Date(parsed.date),
          startTime: parsed.time,
          endTime,
          treatmentType: parsed.treatmentType,
          notes: parsed.notes || null,
          status: "SCHEDULED",
        },
      });

      const dateFormatted = new Date(parsed.date).toLocaleDateString("tr-TR", {
        weekday: "long",
        day: "numeric",
        month: "long",
      });

      const treatmentLabel =
        { BOTOX: "Botoks", DOLGU: "Dolgu", DIS_TEDAVI: "DiÅŸ Tedavi", GENEL: "Genel" }[
          parsed.treatmentType
        ] || parsed.treatmentType;

      let msg = `âœ… Randevu oluÅŸturuldu:\nğŸ“‹ ${patient.name}\nğŸ“… ${dateFormatted} saat ${parsed.time}\nğŸ’‰ ${treatmentLabel}`;
      if (parsed.notes) msg += `\nğŸ“ ${parsed.notes}`;
      if (isNew) msg += `\n\nâš ï¸ Yeni hasta kaydÄ± oluÅŸturuldu: ${patient.name}`;

      return {
        success: true,
        parsed,
        confirmationMessage: msg,
        patientIsNew: isNew,
        recordId: appointment.id,
      };
    }

    if (parsed.type === "INCOME") {
      const { patient, isNew } = await findOrCreatePatient(
        parsed.patientName,
        clinicId
      );

      const treatment = await prisma.treatment.create({
        data: {
          patientId: patient.id,
          clinicId,
          name: parsed.treatmentName || parsed.treatmentType,
          category: parsed.treatmentType,
          amount: parsed.amount,
          date: new Date(),
          description: parsed.notes || null,
        },
      });

      const amountTL = (parsed.amount / 100).toLocaleString("tr-TR");
      const treatmentLabel =
        { BOTOX: "Botoks", DOLGU: "Dolgu", DIS_TEDAVI: "DiÅŸ Tedavi", GENEL: "Genel" }[
          parsed.treatmentType
        ] || parsed.treatmentType;

      let msg = `âœ… Gelir kaydedildi:\nğŸ‘¤ ${patient.name}\nğŸ’‰ ${treatmentLabel}\nğŸ’° ${amountTL} TL`;
      if (isNew) msg += `\n\nâš ï¸ Yeni hasta kaydÄ± oluÅŸturuldu: ${patient.name}`;

      return {
        success: true,
        parsed,
        confirmationMessage: msg,
        patientIsNew: isNew,
        recordId: treatment.id,
      };
    }

    if (parsed.type === "EXPENSE") {
      const expense = await prisma.expense.create({
        data: {
          clinicId,
          description: parsed.description,
          amount: parsed.amount,
          category: parsed.category,
          date: new Date(),
        },
      });

      const amountTL = (parsed.amount / 100).toLocaleString("tr-TR");
      const categoryLabel =
        { MALZEME: "Malzeme", KIRA: "Kira", FATURA: "Fatura", MAAS: "MaaÅŸ", DIGER: "DiÄŸer" }[
          parsed.category
        ] || parsed.category;

      const msg = `âœ… Gider kaydedildi:\nğŸ“¦ ${parsed.description}\nğŸ·ï¸ ${categoryLabel}\nğŸ’¸ ${amountTL} TL`;

      return {
        success: true,
        parsed,
        confirmationMessage: msg,
        recordId: expense.id,
      };
    }

    return {
      success: false,
      parsed,
      confirmationMessage: "âŒ Bilinmeyen mesaj tipi",
    };
  } catch (error) {
    console.error("[WhatsApp Process] Error:", error);
    return {
      success: false,
      parsed,
      confirmationMessage:
        "âŒ Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.",
    };
  }
}
